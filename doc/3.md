# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

## ã‚¹ã‚­ãƒ¼ãƒè¨­å®šå®Ÿæ–½

`prisma/schema.prisma`ã«ãƒ¦ãƒ¼ã‚¶ãƒ†ãƒ¼ãƒ–ãƒ«ã®å®šç¾©ã‚’è¿½åŠ ã™ã‚‹

> TypeScriptã®å‹å®šç¾©ã‚’ç”¨ã„ã¦ã€ãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’è¡¨ç¾ã™ã‚‹

```:prisma/schema.prisma
model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String?
}
```

## ãƒ†ãƒ¼ãƒ–ãƒ«ç”Ÿæˆ

ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ã‚’ç™ºè¡Œã—ã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ç”Ÿæˆã™ã‚‹ï¼ˆDBåˆæœŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

```
npx prisma migrate dev --name init
```

SQLãƒ­ã‚°ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä»¥ä¸‹ã‚³ãƒãƒ³ãƒ‰ãŒç™ºè¡Œã•ã‚Œã€ãƒ†ãƒ¼ãƒ–ãƒ«ãŒä½œæˆã•ã‚Œã‚‹

```
	CREATE TABLE "User" (
	    "id" SERIAL NOT NULL,
	    "email" TEXT NOT NULL,
	    "name" TEXT,

	    PRIMARY KEY ("id")
	);

	-- CreateIndex
	CREATE UNIQUE INDEX "User.email_unique" ON "User"("email");

	    PRIMARY KEY ("id")
	);

	-- CreateIndex
	CREATE UNIQUE INDEX "User.email_unique" ON "User"("email");
```

`prisma/migrations/${timestamp}_init/migration.sql` ã«ç™ºè¡Œã•ã‚ŒãŸSQLã§ã‚‚ç™ºè¡Œã•ã‚ŒãŸSQLã¯ç¢ºèªã§ãã‚‹ã€‚

```sql:prisma/migrations/20210515111505_init/migration.sql
-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "name" TEXT,

    PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User.email_unique" ON "User"("email");
```

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª

1. ã‚«ãƒ©ãƒ è¿½åŠ 
2. æ¡å¤‰æ›´
3. å±æ€§å¤‰æ›´(Not Null)
4. ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 
5. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

### 1. ã‚«ãƒ©ãƒ è¿½åŠ 

ãƒ¦ãƒ¼ã‚¶ãƒ†ãƒ¼ãƒ–ãƒ«ã«é›»è©±ç•ªå·ã‚’è¿½åŠ 

`prisma/schema.prisma`ã‚’ä»¥ä¸‹ã®é€šã‚Šä¿®æ­£

```:prisma/schema.prisma
model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String?
  tel    String? <--- è¿½åŠ 
}
```

* å¤‰æ›´åæ˜ 

```
npx prisma migrate dev --name add_tel_to_user
```

ä»¥ä¸‹SQLãŒç™ºè¡Œã•ã‚Œã€å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹

```
2021-05-16 05:03:13.632 UTC [2225] LOG:  statement: -- AlterTable
	ALTER TABLE "User" ADD COLUMN     "tel" TEXT;
```

* ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
% pwd;find ./prisma/migrations | sort | sed '1d;s/^\.//;s/\/\([^/]*\)$/|--\1/;s/\/[^/|]*/|  /g'
/Users/hirosue/workspace/hello-prisma
|  |  |--20210515111505_init
|  |  |  |--migration.sql
|  |  |--20210516050313_add_tel_to_user <-- è¿½åŠ  
|  |  |  |--migration.sql <-- è¿½åŠ 
|  |  |--migration_lock.toml
```

### 2. æ¡å¤‰æ›´

String? -> TEXTå‹ ã§ä½œæˆã•ã‚ŒãŸãƒ†ãƒ¼ãƒ–ãƒ«å®šç¾©ã‚’ä¿®æ­£ã™ã‚‹ã€‚

`prisma/schema.prisma`ã‚’ä»¥ä¸‹ã®é€šã‚Šä¿®æ­£

```:prisma/schema.prisma
model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String?
  tel    String? @db.VarChar(11) <--- ä¿®æ­£
}
```

* å¤‰æ›´åæ˜ 

```
npx prisma migrate dev --name set_max_length_tel
```

ä»¥ä¸‹SQLãŒç™ºè¡Œã•ã‚Œã€å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹

```
2021-05-16 05:36:11.585 UTC [2368] LOG:  statement: /*
	  Warnings:

	  - You are about to alter the column `tel` on the `User` table. The data in that column could be lost. The data in that column will be cast from `Text` to `VarChar(11)`.

	*/
	-- AlterTable
	ALTER TABLE "User" ALTER COLUMN "tel" SET DATA TYPE VARCHAR(11);
```

* ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
% pwd;find ./prisma/migrations | sort | sed '1d;s/^\.//;s/\/\([^/]*\)$/|--\1/;s/\/[^/|]*/|  /g'
/Users/hirosue/workspace/hello-prisma
|  |  |--20210515111505_init
|  |  |  |--migration.sql
|  |  |--20210516050313_add_tel_to_user
|  |  |  |--migration.sql
|  |  |--20210516053611_set_max_length_tel <-- è¿½åŠ  
|  |  |  |--migration.sql <-- è¿½åŠ  
|  |  |--migration_lock.toml
```

### 3. å±æ€§å¤‰æ›´(Not Null)

åå‰ã‚’ Not Null ã¸å¤‰æ›´

`prisma/schema.prisma`ã‚’ä»¥ä¸‹ã®é€šã‚Šä¿®æ­£

```:prisma/schema.prisma
model User {
  id      Int      @default(autoincrement()) @id
  email   String   @unique
  name    String  <--- ä¿®æ­£
  tel    String? @db.VarChar(11)
}
```

* å¤‰æ›´åæ˜ 

```
npx prisma migrate dev --name set_not_null_name
```

ä»¥ä¸‹SQLãŒç™ºè¡Œã•ã‚Œã€å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹

```
2021-05-16 05:42:07.761 UTC [2386] LOG:  statement: /*
	  Warnings:

	  - Made the column `name` on table `User` required. This step will fail if there are existing NULL values in that column.

	*/
	-- AlterTable
	ALTER TABLE "User" ALTER COLUMN "name" SET NOT NULL;
```

* ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§

```
% pwd;find ./prisma/migrations | sort | sed '1d;s/^\.//;s/\/\([^/]*\)$/|--\1/;s/\/[^/|]*/|  /g'
/Users/hirosue/workspace/hello-prisma
|  |  |--20210515111505_init
|  |  |  |--migration.sql
|  |  |--20210516050313_add_tel_to_user
|  |  |  |--migration.sql
|  |  |--20210516053611_set_max_length_tel
|  |  |  |--migration.sql
|  |  |--20210516054207_set_not_null_name <---- è¿½åŠ 
|  |  |  |--migration.sql <---- è¿½åŠ 
|  |  |--migration_lock.toml
```

### 4. ãƒ†ãƒ¼ãƒ–ãƒ«è¿½åŠ 

ãƒ¦ãƒ¼ã‚¶ã«ç´ã¥ãæŠ•ç¨¿ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’è¿½åŠ ã™ã‚‹ã€‚

`prisma/schema.prisma`ã‚’ä»¥ä¸‹ã®é€šã‚Šä¿®æ­£

```:prisma/schema.prisma
model User {
  id    Int     @id @default(autoincrement())
  email String  @unique
  name  String
  tel   String? @db.VarChar(11)
  posts   Post[] <---- è¿½åŠ 
}

// è¿½åŠ 
model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  author    User?   @relation(fields: [authorId], references: [id])
  authorId  Int?
}
```

* å¤‰æ›´åæ˜ 

```
npx prisma migrate dev --name add_post
```

ä»¥ä¸‹SQLãŒç™ºè¡Œã•ã‚Œã€å¤‰æ›´ãŒåæ˜ ã•ã‚Œã‚‹

```
2021-05-16 05:47:49.051 UTC [2403] LOG:  statement: -- CreateTable
	CREATE TABLE "Post" (
	    "id" SERIAL NOT NULL,
	    "title" TEXT NOT NULL,
	    "content" TEXT,
	    "published" BOOLEAN NOT NULL DEFAULT false,
	    "authorId" INTEGER,

	    PRIMARY KEY ("id")
	);

	-- AddForeignKey
	ALTER TABLE "Post" ADD FOREIGN KEY ("authorId") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE;
```

### 5. åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

`prisma/seed.ts`ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã€ä»¥ä¸‹ã®å†…å®¹ã‚’è¨˜è¼‰ã™ã‚‹

> ã‚³ãƒ¼ãƒ‰ã§åˆæœŸãƒ‡ãƒ¼ã‚¿ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã™ã‚‹

```typescript:prisma/seed.ts
import { PrismaClient } from '@prisma/client'

const prisma = new PrismaClient()

const posts:any = []

for(let i = 0; i < 100; i++) {
    posts.push({ title: `title ${i + 1}`})
}

async function main() {
    const alice = await prisma.user.create({
        data: {
            name: 'Alice',
            email: 'alice@example.com',
            posts: {
                create: posts
            }
        }
    })

    const bob = await prisma.user.create({
        data: {
            name: 'Bob',
            email: 'bob@example.com',
            posts: {
                create: {
                    title: 'Check out Prisma with Next.js',
                }
            }
        }
    })

    console.log({alice, bob})
}

main()
    .catch(e => {
        console.error(e)
        process.exit(1)
    })
    .finally(async () => {
        await prisma.$disconnect()
    })
```

#### åˆæœŸãƒ‡ãƒ¼ã‚¿æŠ•å…¥

```zsh
% npx prisma db seed --preview-feature
Environment variables loaded from .env
Prisma schema loaded from prisma/schema.prisma
Running ts-node "prisma/seed.ts" ...
{
  alice: { id: 1, email: 'alice@example.com', name: 'Alice', tel: null },
  bob: { id: 2, email: 'bob@example.com', name: 'Bob', tel: null }
}

ğŸŒ±  Your database has been seeded.
```

ã¡ãªã¿ã«ã€ä»¥ä¸‹ã®éƒ¨åˆ†ã¯

```typescript
    const bob = await prisma.user.create({
        data: {
            name: 'Bob',
            email: 'bob@example.com',
            posts: {
                create: {
                    title: 'Check out Prisma with Next.js',
                }
            }
        }
    })
```

ã“ã‚“ãªæ„Ÿã˜ã«è‡ªå‹•çš„ã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¡Œã—ã€Atomicityï¼ˆåŸå­æ€§ï¼‰ã‚’æ‹…ä¿ã™ã‚‹

```bash
2021-05-16 10:44:45.102 UTC [2999] LOG:  statement: BEGIN
2021-05-16 10:44:45.103 UTC [2999] LOG:  execute s0: INSERT INTO "postgres"."User" ("email","name") VALUES ($1,$2) RETURNING "postgres"."User"."id"
2021-05-16 10:44:45.103 UTC [2999] DETAIL:  parameters: $1 = 'bob@example.com', $2 = 'Bob'
2021-05-16 10:44:45.105 UTC [2999] LOG:  execute s1: INSERT INTO "postgres"."Post" ("title","published","authorId") VALUES ($1,$2,$3) RETURNING "postgres"."Post"."id"
2021-05-16 10:44:45.105 UTC [2999] DETAIL:  parameters: $1 = 'Check out Prisma with Next.js', $2 = 'f', $3 = '2'
2021-05-16 10:44:45.106 UTC [2999] LOG:  execute s2: SELECT "postgres"."User"."id", "postgres"."User"."email", "postgres"."User"."name", "postgres"."User"."tel" FROM "postgres"."User" WHERE "postgres"."User"."id" = $1 LIMIT $2 OFFSET $3
2021-05-16 10:44:45.106 UTC [2999] DETAIL:  parameters: $1 = '2', $2 = '1', $3 = '0'
2021-05-16 10:44:45.108 UTC [2999] LOG:  statement: COMMIT
```

#### åæ˜ ç¢ºèª

Prismaã¯ã€ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã§å‹•ä½œã™ã‚‹GUIã®ãƒ„ãƒ¼ãƒ«ï¼ˆ`Prisma Studio`ï¼‰ã‚‚æä¾›ã—ã¦ã„ã‚‹ã€‚

```
npx prisma studio
```

